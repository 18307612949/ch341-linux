From c7facc54983ee9dbc51aab59675295b648800ee6 Mon Sep 17 00:00:00 2001
From: Karl Palsson <karlp@tweak.net.au>
Date: Tue, 18 Mar 2014 23:59:27 +0000
Subject: [PATCH 2/2] SQUISh: add mark/space parity support

Include a note that ch340 doesn't support stop/databits
---
 drivers/usb/serial/ch341.c | 19 +++++++++++++++----
 1 file changed, 15 insertions(+), 4 deletions(-)

diff --git a/drivers/usb/serial/ch341.c b/drivers/usb/serial/ch341.c
index 456ddd0..446bedb 100644
--- a/drivers/usb/serial/ch341.c
+++ b/drivers/usb/serial/ch341.c
@@ -372,13 +372,24 @@ static void ch341_set_termios(struct tty_struct *tty,
 	 * (cflag & CSIZE) : data bits [5, 8]
 	 * (cflag & CSTOPB) : stop bits [1, 2]
 	 */
+	/* CH340 doesn't appear to support variable stop bits or data bits */
 	if (C_PARENB(tty)) {
 		if (C_PARODD(tty)) {
-			dev_dbg(&port->dev, "parity = odd\n");
-			par_flags = 0xcb;
+			if (tty->termios.c_cflag & CMSPAR) {
+				dev_dbg(&port->dev, "parity = mark\n");
+				par_flags = 0xeb;
+			} else {
+				dev_dbg(&port->dev, "parity = odd\n");
+				par_flags = 0xcb;
+			}
 		} else {
-			dev_dbg(&port->dev, "parity = even\n");
-			par_flags = 0xdb;
+			if (tty->termios.c_cflag & CMSPAR) {
+				dev_dbg(&port->dev, "parity = space\n");
+				par_flags = 0xfb;
+			} else {
+				dev_dbg(&port->dev, "parity = even\n");
+				par_flags = 0xdb;
+			}
 		}
 	} else {
 		dev_dbg(&port->dev, "parity = none\n");
-- 
1.8.3.1

